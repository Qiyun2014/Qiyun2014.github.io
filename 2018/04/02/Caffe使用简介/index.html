<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="#Caffe使用简介 ##目录[TOC] ##下载源码http://caffe.berkeleyvision.org/installation.html12git clone https://github.com/BVLC/caffe.gitcd caffe-master ##CMake 编译123456mkdir buildcd buildcmake ..make allmake install">
<meta property="og:type" content="article">
<meta property="og:title" content="Caffe使用简介">
<meta property="og:url" content="https://github.com/Qiyun2014/2018/04/02/Caffe使用简介/index.html">
<meta property="og:site_name" content="祁云的博客">
<meta property="og:description" content="#Caffe使用简介 ##目录[TOC] ##下载源码http://caffe.berkeleyvision.org/installation.html12git clone https://github.com/BVLC/caffe.gitcd caffe-master ##CMake 编译123456mkdir buildcd buildcmake ..make allmake install">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-05-09T06:28:19.894Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Caffe使用简介">
<meta name="twitter:description" content="#Caffe使用简介 ##目录[TOC] ##下载源码http://caffe.berkeleyvision.org/installation.html12git clone https://github.com/BVLC/caffe.gitcd caffe-master ##CMake 编译123456mkdir buildcd buildcmake ..make allmake install">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://github.com/Qiyun2014/2018/04/02/Caffe使用简介/">





  <title>Caffe使用简介 | 祁云的博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">祁云的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-schedule">
          <a href="/schedule/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-calendar"></i> <br>
            
            Schedule
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/Qiyun2014/2018/04/02/Caffe使用简介/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Qiyun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="祁云的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Caffe使用简介</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-02T19:38:48+08:00">
                2018-04-02
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/04/02/Caffe使用简介/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/04/02/Caffe使用简介/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>#Caffe使用简介</p>
<p>##目录<br>[TOC]</p>
<p>##下载源码<br><a href="http://caffe.berkeleyvision.org/installation.html" target="_blank" rel="noopener">http://caffe.berkeleyvision.org/installation.html</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/BVLC/caffe.git</span><br><span class="line">cd caffe-master</span><br></pre></td></tr></table></figure></p>
<p>##CMake 编译<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir build</span><br><span class="line">cd build</span><br><span class="line">cmake ..</span><br><span class="line">make all</span><br><span class="line">make install</span><br><span class="line">make</span><br></pre></td></tr></table></figure></p>
<p>##使用caffe库训练LeNet在MNIST</p>
<p>###准确数据集<br>根据shell文件（wget或gunzip）安装mnist_train_lmdb和mnist_test_lmbd数据文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./data/mnist/get_mnist.sh</span><br><span class="line">./example/mnist/create_mnist.sh</span><br></pre></td></tr></table></figure></p>
<p>LeNet包含CNN，由一个卷积层，一个汇集层，另一个卷积层，然后是一个汇集层，然后是两个完全连接的层<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/examples/mnist/lenet_train_test.prototxt</span><br></pre></td></tr></table></figure></p>
<p>###定义MNIST网络</p>
<p>mnist 是一个手写数字库，由 DL 大牛YanLeCun进行维护。mnist最初用于支票上的手写数字识别,现在成了DL的入门练习库。针对mnist识别的专门模型是Lenet，算是最早的 CNN模型了。</p>
<p><a href="http://caffe.berkeleyvision.org/gathered/examples/mnist.html" target="_blank" rel="noopener">http://caffe.berkeleyvision.org/gathered/examples/mnist.html</a><br><strong>设定网络名称</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name: &quot;LeNet&quot;</span><br></pre></td></tr></table></figure>
<p>从LMDB文件<strong>读取MNIST的数据</strong>，下面是定义的一个数据层；<br>name: 表示该层的名称，可随意取<br>type: 层类型，如果是Data，表示数据来源于LevelDB或LMDB。根据数据的来源不同，数据层的类型也不同。一般在练习的时候，我们都是采用LevelDB或LMDB数据，因此层类型设置为Data。 </p>
<p>Transformations: 数据的预处理，可以将数据变换到定义的范围内。如设置scale为0.00390625，实际上就是1/255, 即将输入数据由0-255归一化到0~1之间<br>source：读取lmdb的路径<br>两个blobs：data blob和label blob</p>
<p>数据层是每个模型的最底层，是模型的入口，仅提供数据的输入，也提供数据从Blobs转换成别的格式进行保存输出。通常数据的预处理(如减去均值,缩放,裁剪和镜像等)，也在这层设置参数实现。 </p>
<p>数据来源可以来自高效的数据库(如LevelDB和LMDB)，也可以直接来 于内存。如果 是很注重效率的话，数 据也可来 磁盘的hdf5 件和图 格式 件。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">layer &#123;</span><br><span class="line">  name: &quot;mnist&quot;	</span><br><span class="line">  type: &quot;Data&quot;</span><br><span class="line">  transform_param &#123;</span><br><span class="line">    scale: 0.00390625</span><br><span class="line">  &#125;</span><br><span class="line">  data_param &#123;</span><br><span class="line">    source: &quot;mnist_train_lmdb&quot;</span><br><span class="line">    backend: LMDB</span><br><span class="line">    batch_size: 64</span><br><span class="line">  &#125;</span><br><span class="line">  top: &quot;data&quot;</span><br><span class="line">  top: &quot;label&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>内存数据(MemoryData)</strong></p>
<p>batch_size: 每一次处理的数据个数，比如2<br>channels: 通道数<br>height: 高度<br>width: 宽度 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">layer &#123;</span><br><span class="line">  top: &quot;data&quot;</span><br><span class="line">  top: &quot;label&quot;</span><br><span class="line">  name: &quot;memory_data&quot;</span><br><span class="line">  type: &quot;MemoryData&quot;</span><br><span class="line">  memory_data_param&#123;</span><br><span class="line">    batch_size: 2</span><br><span class="line">    height: 100</span><br><span class="line">    width: 100</span><br><span class="line">    channels: 1</span><br><span class="line">  &#125;</span><br><span class="line">  transform_param &#123;</span><br><span class="line">    scale: 0.0078125</span><br><span class="line">    mean_file: &quot;mean.proto&quot;</span><br><span class="line">    mirror: false</span><br><span class="line">&#125; &#125;</span><br></pre></td></tr></table></figure>
<p><strong>HDF5数据（HDF5Data）</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">layer &#123;</span><br><span class="line">  name: &quot;data&quot;</span><br><span class="line">  type: &quot;HDF5Data&quot;</span><br><span class="line">  top: &quot;data&quot;</span><br><span class="line">  top: &quot;label&quot;</span><br><span class="line">  hdf5_data_param &#123;</span><br><span class="line">    source: &quot;examples/hdf5_classification/data/train.txt&quot;</span><br><span class="line">    batch_size: 10</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>定义第一个卷积层</strong><br>设定20个通道的输出，卷积核大小是5，步长是1<br>The fillers allow us to randomly initialize the value of the weights and bias. For the weight filler, we will use the xavier algorithm that automatically determines the scale of initialization based on the number of input and output neurons. For the bias filler, we will simply initialize it as constant, with the default filling value 0.</p>
<p>lr_mults are the learning rate adjustments for the layer’s learnable parameters. In this case, we will set the weight learning rate to be the same as the learning rate given by the solver during runtime, and the bias learning rate to be twice as large as that - this usually leads to better convergence rates</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">layer &#123;</span><br><span class="line">  name: &quot;conv1&quot;</span><br><span class="line">  type: &quot;Convolution&quot;</span><br><span class="line">  param &#123; lr_mult: 1 &#125;</span><br><span class="line">  param &#123; lr_mult: 2 &#125;</span><br><span class="line">  convolution_param &#123;</span><br><span class="line">    num_output: 20</span><br><span class="line">    kernel_size: 5</span><br><span class="line">    stride: 1</span><br><span class="line">    weight_filler &#123;</span><br><span class="line">      type: &quot;xavier&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    bias_filler &#123;</span><br><span class="line">      type: &quot;constant&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  bottom: &quot;data&quot;</span><br><span class="line">  top: &quot;conv1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>###定义MNIST Solver</p>
<p>test_iter: 测试样本，训练的图片个数/Batch_size<br>test_interval: 迭代次数<br>base_lr：lr是learning rate，学习速率，数据量较少的时候需要设置小一点，防止过早收敛<br>max_iter： 最大迭代</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># The train/test net protocol buffer definition</span><br><span class="line">net: &quot;examples/mnist/lenet_train_test.prototxt&quot;</span><br><span class="line"># test_iter specifies how many forward passes the test should carry out.</span><br><span class="line"># In the case of MNIST, we have test batch size 100 and 100 test iterations,</span><br><span class="line"># covering the full 10,000 testing images.</span><br><span class="line">test_iter: 100</span><br><span class="line"># Carry out testing every 500 training iterations.</span><br><span class="line">test_interval: 500</span><br><span class="line"># The base learning rate, momentum and the weight decay of the network.</span><br><span class="line">base_lr: 0.01</span><br><span class="line">momentum: 0.9</span><br><span class="line">weight_decay: 0.0005</span><br><span class="line"># The learning rate policy</span><br><span class="line">lr_policy: &quot;inv&quot;</span><br><span class="line">gamma: 0.0001</span><br><span class="line">power: 0.75</span><br><span class="line"># Display every 100 iterations</span><br><span class="line">display: 100</span><br><span class="line"># The maximum number of iterations</span><br><span class="line">max_iter: 10000</span><br><span class="line"># snapshot intermediate results</span><br><span class="line">snapshot: 5000</span><br><span class="line">snapshot_prefix: &quot;examples/mnist/lenet&quot;</span><br><span class="line"># solver mode: CPU or GPU</span><br><span class="line">solver_mode: GPU</span><br></pre></td></tr></table></figure>
<p>###训练自己的模型</p>
<p><strong>归类</strong>好需要的数据集，放置在统一的文件夹目录<br>生成对应的trail.txt和test.txt文件，用于转图片为lmdb文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line"></span><br><span class="line">root = &quot;/Users/qiyun/Downloads/caffe-1.0/data/test_mnist/&quot;</span><br><span class="line">data = &apos;train&apos;</span><br><span class="line">print(root)</span><br><span class="line">path = os.listdir(root + data)</span><br><span class="line">path.sort()</span><br><span class="line">file = open(root + &apos;train.txt&apos;, &apos;w&apos;)</span><br><span class="line"></span><br><span class="line">i = 0</span><br><span class="line">j = 0</span><br><span class="line"></span><br><span class="line">for line in path:</span><br><span class="line">    str = root + data + &apos;/&apos; + line</span><br><span class="line">    print(str)</span><br><span class="line"></span><br><span class="line">    if &apos;DS_Store&apos; in str:</span><br><span class="line">        print(&quot;error file path ....&quot;)</span><br><span class="line">    else:</span><br><span class="line">        for child in os.listdir(str):</span><br><span class="line">            str1 = data + &apos;/&apos; + line + &apos;/&apos; + child</span><br><span class="line">            filePath = root + str1</span><br><span class="line">            fix = os.path.splitext(str1)</span><br><span class="line"></span><br><span class="line">            print(&quot;####### in  &quot; + filePath)</span><br><span class="line">            print(fix)</span><br><span class="line">            d = &apos;%s&apos; %(i)</span><br><span class="line">            e = &apos;%s&apos; %(j)</span><br><span class="line">            t = fix[0] + fix[1] + &apos; &apos; + e</span><br><span class="line">            #t = data + &apos;/&apos; + line + &apos;/&apos; + &quot;img&quot; + d + fix[1] + &apos; &apos; + e</span><br><span class="line">            print(t)</span><br><span class="line">            file.write(t +&apos;\n&apos;)</span><br><span class="line">            outpath = root + t;</span><br><span class="line">            print(&quot;####### out  &quot; + outpath)</span><br><span class="line">            #os.rename(filePath, newfile)</span><br><span class="line">            i = i + 1</span><br><span class="line">        j = j + 1</span><br><span class="line"></span><br><span class="line">file.close()</span><br></pre></td></tr></table></figure></p>
<p><strong>批量处理图片</strong><br>LeNet训练集的图片需要28x28的尺寸，各个训练网络都有特定尺寸要求<br>如果图片尺寸不合适，可以使用下面shell脚步进行处理（需要安装ImageMagick）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env bash</span><br><span class="line"></span><br><span class="line">src_dir=/Users/qiyun/Downloads/caffe-1.0/data/my_mnist/train/</span><br><span class="line">number=1</span><br><span class="line">dir=`ls -1 $src_dir`</span><br><span class="line">for dir_name in `ls -1 $src_dir`;</span><br><span class="line">do</span><br><span class="line">    if [ -d $src_dir$dir_name ]</span><br><span class="line">    then</span><br><span class="line">        echo $src_dir$dir_name</span><br><span class="line">        number=1</span><br><span class="line">        for file_name in `ls -l $src_dir$dir_name | grep ^- | awk &apos;&#123;print $9&#125;&apos;`;</span><br><span class="line">        do</span><br><span class="line">            echo $src_dir$dir_name&quot;/&quot;$file_name</span><br><span class="line">            convert +profile &apos;*&apos; $src_dir$dir_name&quot;/&quot;$file_name -quality 100 -resize &apos;28x28!&apos; -gravity Center -crop 28x28+0+0 +repage $src_dir$dir_name&quot;/&quot;$number&quot;_img&quot;&quot;.jpg&quot;</span><br><span class="line">            #mv $src_dir$dir_name&quot;/&quot;$file_name $src_dir$dir_name&quot;/&quot;$file_name</span><br><span class="line">            rm -rf $src_dir$dir_name&quot;/&quot;$file_name</span><br><span class="line">            echo $number</span><br><span class="line">            let number=number+1</span><br><span class="line">        done</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>###生成LMDB文件</p>
<p><strong>需要修改对应的路径</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env sh</span><br><span class="line"># Create the imagenet lmdb inputs</span><br><span class="line"># N.B. set the path to the imagenet train + val data dirs</span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">EXAMPLE=data/my_mnist</span><br><span class="line">DATA=/Users/qiyun/Downloads/caffe-1.0/data/my_mnist/</span><br><span class="line">TOOLS=build/tools</span><br><span class="line"></span><br><span class="line">TRAIN_DATA_ROOT=/Users/qiyun/Downloads/caffe-1.0/data/my_mnist/</span><br><span class="line">VAL_DATA_ROOT=/Users/qiyun/Downloads/caffe-1.0/data/my_mnist/</span><br><span class="line"></span><br><span class="line"># Set RESIZE=true to resize the images to 256x256. Leave as false if images have</span><br><span class="line"># already been resized using another tool.</span><br><span class="line">RESIZE=false</span><br><span class="line">if $RESIZE; then</span><br><span class="line">  RESIZE_HEIGHT=28</span><br><span class="line">  RESIZE_WIDTH=28</span><br><span class="line">else</span><br><span class="line">  RESIZE_HEIGHT=0</span><br><span class="line">  RESIZE_WIDTH=0</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ ! -d &quot;$TRAIN_DATA_ROOT&quot; ]; then</span><br><span class="line">  echo &quot;Error: TRAIN_DATA_ROOT is not a path to a directory: $TRAIN_DATA_ROOT&quot;</span><br><span class="line">  echo &quot;Set the TRAIN_DATA_ROOT variable in create_imagenet.sh to the path&quot; \</span><br><span class="line">       &quot;where the ImageNet training data is stored.&quot;</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ ! -d &quot;$VAL_DATA_ROOT&quot; ]; then</span><br><span class="line">  echo &quot;Error: VAL_DATA_ROOT is not a path to a directory: $VAL_DATA_ROOT&quot;</span><br><span class="line">  echo &quot;Set the VAL_DATA_ROOT variable in create_imagenet.sh to the path&quot; \</span><br><span class="line">       &quot;where the ImageNet validation data is stored.&quot;</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">echo &quot;Creating train lmdb...&quot;</span><br><span class="line"></span><br><span class="line">GLOG_logtostderr=1 $TOOLS/convert_imageset \</span><br><span class="line">    --resize_height=$RESIZE_HEIGHT \</span><br><span class="line">    --resize_width=$RESIZE_WIDTH \</span><br><span class="line">    --shuffle \</span><br><span class="line">    $TRAIN_DATA_ROOT \</span><br><span class="line">    $DATA/train.txt \</span><br><span class="line">    $EXAMPLE/train_lmdb</span><br><span class="line"></span><br><span class="line">echo &quot;Creating val lmdb...&quot;</span><br><span class="line"></span><br><span class="line">GLOG_logtostderr=1 $TOOLS/convert_imageset \</span><br><span class="line">    --resize_height=$RESIZE_HEIGHT \</span><br><span class="line">    --resize_width=$RESIZE_WIDTH \</span><br><span class="line">    --shuffle \</span><br><span class="line">    $VAL_DATA_ROOT \</span><br><span class="line">    $DATA/test.txt \</span><br><span class="line">    $EXAMPLE/val_lmdb</span><br><span class="line"></span><br><span class="line">echo &quot;Done.&quot;</span><br></pre></td></tr></table></figure>
<p><strong>生成均值文件，用于最后的预测数据</strong></p>
<p>Caffe 中使用的均值数据格式是 binaryproto, 作者为我们提供了一个计算均值的文件 compute_image_mean.cpp，放在 Caffe 根目录下的 tools 文件夹里面。编译后的可执行体放在 build/tools/ 下面，我们直接调用就可以了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./build/tools/compute_image_mean examples/mnist/mnist_train_lmdb examples/mnist/mean.binaryproto</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env sh</span><br><span class="line"># Compute the mean image from the imagenet training lmdb</span><br><span class="line"># N.B. this is available in data/ilsvrc12</span><br><span class="line"></span><br><span class="line">EXAMPLE=data/my_mnist</span><br><span class="line">DATA=/Users/qiyun/Downloads/caffe-1.0/data/my_mnist</span><br><span class="line">TOOLS=build/tools</span><br><span class="line"></span><br><span class="line">$TOOLS/compute_image_mean $EXAMPLE/train_lmdb \</span><br><span class="line">  $DATA/imagenet_mean.binaryproto</span><br><span class="line"></span><br><span class="line">echo &quot;Done.&quot;</span><br></pre></td></tr></table></figure>
<p><strong>开始训练</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env sh</span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">./build/tools/caffe train \</span><br><span class="line">    --solver=data/my_mnist/lenet_solver.prototxt</span><br></pre></td></tr></table></figure>
<p>##使用</p>
<p><strong>测试</strong></p>
<p>训练完成后，可以直接使用build下的代码进行测试，命令如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env sh</span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">./build/examples/cpp_classification/classification.bin data/my_mnist/lenet.prototxt ./data/my_mnist/pubg_classify.caffemodel data/my_mnist/pubg_imagenet_mean.binaryproto data/my_mnist/pubg_labels.txt /Users/qiyun/Desktop/outputImage.jpg</span><br></pre></td></tr></table></figure>
<p><strong>结果</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yuns-iMac:caffe-1.0 qiyun$ ./data/my_mnist/TestImage.sh </span><br><span class="line">---------- Prediction for /Users/qiyun/Desktop/outputImage.jpg ----------</span><br><span class="line">1.0000 - &quot;1_(生存)&quot;</span><br><span class="line">0.0000 - &quot;2_(生存 english)&quot;</span><br><span class="line">0.0000 - &quot;0_(存活)&quot;</span><br><span class="line">0.0000 - &quot;4_(不在游戏中)&quot;</span><br><span class="line">0.0000 - &quot;3_(加入)&quot;</span><br></pre></td></tr></table></figure>
<p>##附录<br>Google Protocol Buffer的使用和原理<br><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-gpb/index.html" target="_blank" rel="noopener">https://www.ibm.com/developerworks/cn/linux/l-cn-gpb/index.html</a><br>makefile编译调用Caffe框架的C++程序<br><a href="http://yongyuan.name/blog/compiling-cpp-code-using-caffe.html" target="_blank" rel="noopener">http://yongyuan.name/blog/compiling-cpp-code-using-caffe.html</a><br><a href="https://github.com/Tencent/ncnn">https://github.com/Tencent/ncnn</a><br>ncnn 组件使用指北 alexnet<br><a href="https://github.com/Tencent/ncnn/wiki/ncnn-组件使用指北-alexnet">https://github.com/Tencent/ncnn/wiki/ncnn-组件使用指北-alexnet</a><br>python使用caffe<br><a href="http://adilmoujahid.com/posts/2016/06/introduction-deep-learning-python-caffe/" target="_blank" rel="noopener">http://adilmoujahid.com/posts/2016/06/introduction-deep-learning-python-caffe/</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/02/15/使用Tesseract OCR/" rel="next" title="Tesseract OCR使用介绍">
                <i class="fa fa-chevron-left"></i> Tesseract OCR使用介绍
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/05/21/ImageMagick/" rel="prev" title="ImageMagick 7.0.7-16使用">
                ImageMagick 7.0.7-16使用 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div class="ds-thread" data-thread-key="2018/04/02/Caffe使用简介/" data-title="Caffe使用简介" data-url="https://github.com/Qiyun2014/2018/04/02/Caffe使用简介/">
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Qiyun</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Qiyun2014" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="shagengba@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Qiyun</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"qiyun"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  


















  





  

  

  

  
  

  

  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.4"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.4"></script>


  

</body>
</html>
